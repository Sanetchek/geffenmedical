<?php

/**
 * Handler for FAQ Search Form
 */
function handle_faq_form()
{
  // Get form data
  $s = sanitize_text_field($_POST['search']);

  // Variables
  $response = [];

  $args = array(
    'post_type' => 'fl_faq',
    'posts_per_page' => -1,
    's' => $s
  );

  $custom_posts = get_posts($args);
  $per_page = 10;
  $faq_count = 0;
  $pages = 1;
  $current = ' active';

  foreach ($custom_posts as $post):

    if (($faq_count % $per_page) === 0):
      $response['template'] .= '<section id="paginated_content_' . $pages . '" class="paginated-content' . $current . '">';

      $current = '';
      $pages++;

    endif;

    $response['template'] .= '<div class="faq-category-post">';
    $response['template'] .= '<h3 class="faq-category-title">' . $post->post_title . '</h3>';
    $response['template'] .= '<div class="faq-category-text">' . $post->post_content . '</div>';
    $response['template'] .= '</div>';

    if (($faq_count % $per_page) === ($per_page - 1)):
      $response['template'] .= '</section>';
    endif;

    $faq_count++;

  endforeach;

  if (($pages - 1) > 1):
    $response['template'] .= '<div class="paginated-pages" data-pages="' . ($pages - 1) . '">';
    $response['template'] .= '<a href="javascript:void(0)" class="paginated-number page-next" data-page="2"> < </a>';

    for ($page = $pages - 1; $page > 0; $page--):
      $cur = $page == 1 ? ' current' : '';
      $response['template'] .= '<a href="javascript:void(0)" class="paginated-number paginated-count' . $cur . '" data-page="' . $page . '">' . $page . '</a>';
    endfor;

    $response['template'] .= '<a href="javascript:void(0)" class="paginated-number page-prev hidden" data-page="0"> > </a>';
    $response['template'] .= '</div>';
  endif;

  // Return a response
  wp_send_json($response);
  wp_die(); // This is required to terminate the script
}

add_action('wp_ajax_handle_faq_form', 'handle_faq_form');
add_action('wp_ajax_nopriv_handle_faq_form', 'handle_faq_form');

/**
 * Apply Coupon Code
 */
function geffen_apply_coupon()
{
  if (isset($_POST['coupon_codes'])) {
    $coupon_codes = $_POST['coupon_codes'];

    // Split the string of coupon codes into an array
    $coupon_codes_array = explode(',', $coupon_codes);

    // Apply each coupon code separately
    $success = true;
    foreach ($coupon_codes_array as $coupon_code) {
      $coupon_code = trim($coupon_code); // Remove any extra whitespace
      if (!WC()->cart->apply_coupon($coupon_code)) {
        $success = false;
        break; // If any coupon fails to apply, stop applying further coupons
      }
    }

    if ($success) {
      $response = array(
        'message' => 'Coupons applied successfully.',
        'cart_totals' => WC()->cart->get_totals(),
      );
      wp_send_json_success($response);
    } else {
      $response = array(
        'message' => 'Coupons could not be applied.',
      );
      wp_send_json_error($response);
    }
  }
  wp_die();
}
add_action('wp_ajax_apply_coupon', 'geffen_apply_coupon');
add_action('wp_ajax_nopriv_apply_coupon', 'geffen_apply_coupon');

// get template part like a string
function get_part_string($template_path)
{
  // Start output buffering
  ob_start();

  // Include template part
  get_template_part($template_path);

  // Assign buffered content to a variable
  return ob_get_clean();
}

/**
 * Save Done Fields
 */
function save_done_fields()
{
  $area = $_POST['area'];
  $city = $_POST['city'];
  $street = $_POST['street'];
  $number = $_POST['number'];
  $user_id = get_current_user_id();
  $response = [];

  if (isset($area)) {
    // Update the field value for the specific user
    update_field('country_area', $area, 'user_' . $user_id);
    $response['area'] = $area;
  }

  if (isset($city)) {
    // Update the field value for the specific user
    update_field('city', $city, 'user_' . $user_id);
    $response['city'] = $city;
  }

  if (isset($street)) {
    // Update the field value for the specific user
    update_field('address', $street, 'user_' . $user_id);
    $response['address'] = $street;
  }

  if (isset($number)) {
    // Update the field value for the specific user
    update_field('station_number', $number, 'user_' . $user_id);
    $response['station_number'] = $number;
  }

  echo json_encode($response);
  wp_die();
}
add_action('wp_ajax_save_done_fields', 'save_done_fields');
add_action('wp_ajax_nopriv_save_done_fields', 'save_done_fields');

// Save Billing form
function save_billing_user_profile()
{
  if (isset($_POST['formData'])) {
    parse_str($_POST['formData'], $formFields);

    // Get the current user ID
    $user_id = get_current_user_id();

    // Update user meta with the form data
    if ($user_id) {
      update_user_meta($user_id, 'billing_first_name', $formFields['billing_first_name']);
      update_user_meta($user_id, 'billing_last_name', $formFields['billing_last_name']);
      update_user_meta($user_id, 'billing_company', $formFields['billing_company']);
      update_user_meta($user_id, 'billing_address_1', $formFields['billing_street']);
      update_user_meta($user_id, 'billing_city', $formFields['billing_city']);
      update_user_meta($user_id, 'billing_postcode', $formFields['billing_postal']);
      update_user_meta($user_id, 'billing_country', $formFields['email']);
      update_user_meta($user_id, 'billing_phone', $formFields['billing_phone']);
      update_user_meta($user_id, 'billing_email', $formFields['billing_email']);
      update_user_meta($user_id, 'billing_address_type', $formFields['billing_address_type']);
      update_user_meta($user_id, 'billing_house_number', $formFields['billing_house_number']);
      update_user_meta($user_id, 'billing_apartment_number', $formFields['billing_apartment']);

      // Variables
      $coupon_codes = $_POST['coupons'];
      $shipping_method = $_POST['shipping_method'];

      // Add Coupons
      if (isset($coupon_codes)) {
        add_multiple_coupons($coupon_codes);
      }

      // Update the chosen shipping method
      WC()->session->set('chosen_shipping_methods', array($shipping_method));
      WC()->cart->calculate_shipping();

      // Update total
      WC()->cart->calculate_totals();

      $review_order = get_part_string('template-parts/checkout-one-page/review-order');

      // Return success message or data
      wp_send_json([
        'name' => $formFields['billing_first_name'] . ' ' . $formFields['billing_last_name'],
        'city' => $formFields['billing_city'],
        'address' => $formFields['billing_street'],
        'review_order' => $review_order,
      ]);
    } else {
      // Return error message if user ID is not found
      wp_send_json_error('User ID not found.');
    }
  }

  // Return error if form data is missing
  wp_send_json_error('Form data is missing.');
  wp_die();
}
add_action('wp_ajax_save_billing_user_profile', 'save_billing_user_profile');
add_action('wp_ajax_nopriv_save_billing_user_profile', 'save_billing_user_profile');

// Save Shipping form
function save_shipping_user_profile()
{
  if (isset($_POST['formData'])) {
    parse_str($_POST['formData'], $formFields);

    // Get the current user ID
    $user_id = get_current_user_id();

    // Update user meta with the form data
    if ($user_id) {
      update_user_meta($user_id, 'shipping_first_name', $formFields['shipping_first_name']);
      update_user_meta($user_id, 'shipping_last_name', $formFields['shipping_last_name']);
      update_user_meta($user_id, 'shipping_company', $formFields['shipping_company']);
      update_user_meta($user_id, 'shipping_address_1', $formFields['shipping_street']);
      update_user_meta($user_id, 'shipping_city', $formFields['shipping_city']);
      update_user_meta($user_id, 'shipping_postcode', $formFields['shipping_postal']);
      update_user_meta($user_id, 'shipping_country', $formFields['email']);
      update_user_meta($user_id, 'shipping_phone', $formFields['shipping_phone']);
      update_user_meta($user_id, 'shipping_email', $formFields['shipping_email']);
      update_user_meta($user_id, 'shipping_address_type', $formFields['shipping_address_type']);
      update_user_meta($user_id, 'shipping_house_number', $formFields['shipping_house_number']);
      update_user_meta($user_id, 'shipping_apartment_number', $formFields['shipping_apartment']);

      // Variables
      $coupon_codes = $_POST['coupons'];
      $shipping_method = $_POST['shipping_method'];

      // Add Coupons
      if (isset($coupon_codes)) {
        add_multiple_coupons($coupon_codes);
      }

      // Update the chosen shipping method
      WC()->session->set('chosen_shipping_methods', array($shipping_method));
      WC()->cart->calculate_shipping();

      // Update total
      WC()->cart->calculate_totals();

      $review_order = get_part_string('template-parts/checkout-one-page/review-order');

      // Return success message or data
      wp_send_json([
        'name' => $formFields['shipping_first_name'] . ' ' . $formFields['shipping_last_name'],
        'city' => $formFields['shipping_city'],
        'address' => $formFields['shipping_street'],
        'review_order' => $review_order,
      ]);
    } else {
      // Return error message if user ID is not found
      wp_send_json_error('User ID not found.');
    }
  }

  // Return error if form data is missing
  wp_send_json_error('Form data is missing.');
  wp_die();
}
add_action('wp_ajax_save_shipping_user_profile', 'save_shipping_user_profile');
add_action('wp_ajax_nopriv_save_shipping_user_profile', 'save_shipping_user_profile');

// Save shipping_checkbox into user profile
function save_shipping_checkbox()
{
  if (isset($_POST['isChecked'])) {
    $isChecked = $_POST['isChecked'];

    $current_user = wp_get_current_user();
    $user_id = $current_user->ID;

    // Update the user meta for 'shipping_checkbox' field
    update_user_meta($user_id, 'shipping_checkbox', $isChecked);

    // Send a success response back
    wp_send_json_success('Checkbox state updated successfully.');
  } else {
    // Send an error response if data is missing
    wp_send_json_error('Checkbox state data missing.');
  }
}
add_action('wp_ajax_save_shipping_checkbox', 'save_shipping_checkbox');
add_action('wp_ajax_nopriv_save_shipping_checkbox', 'save_shipping_checkbox');

/**
 * Create user in WPDB
 *
 * @param [type] $user_id
 * @param [type] $phone_number
 * @return void
 */
function create_user_wpdb($phone_number)
{
  $random_password = wp_generate_password(12);
  $new_user_id = wp_create_user($phone_number, $random_password);

  update_user_meta($new_user_id, 'first_name', $phone_number); // Save custom fields
  update_user_meta($new_user_id, 'billing_phone', $phone_number); // Save custom fields
  update_user_meta($new_user_id, 'phone_number', $phone_number); // Save custom fields
  update_user_meta($new_user_id, 'geffen_phone', $phone_number); // Save custom fields

  if (!$new_user_id) {
    $message = __('אינך רשום למערכת ', 'geffen');
    wp_send_json(['success' => false, 'message' => $message]);
    return;
  }

  return $new_user_id;
}

/**
 * Generate sms parameters
 *
 * @param [type] $message
 * @param [type] $phone_number
 * @return []
 */
function sms_params($message, $phone_number)
{
  return [
    'UserName' => 'Shira.Marton',
    'Password' => '69A54A13ED07E8B18D0E861394DABED972228E9605469B51E2D5FCAEFD350190',
    'SenderName' => 'geffenSMS',
    'CCToEmail' => 'vlad.php.jwz@gmail.com',
    'SMSOperation' => 'Push',
    'DeliveryDelayInMinutes' => 0,
    'ExpirationDelayInMinutes' => 1440,
    'Message' => $message,
    'MessageOption' => 'Regular',
    'Price' => '3.00',
    'SendToPhoneNumbers' => $phone_number
  ];
}

/**
 * Send SMS Code to phone number
 */
function login_by_phone() {
  if (isset($_POST['phone'])) {
    // Sanitize and process phone number
    $phone_number = sanitize_text_field($_POST['phone']);
    $phone_number = preg_replace('/(\W*)/', '', $phone_number); // Clear all symbols

    // Retrieve user ID from DB by phone number
    $users = get_user_id_by_phone_number($phone_number);
    $user_id = $users[0];
    $new_user_id = 0;
    $is_crm_multiaccount = false;

    // Authenticate user from CRM
    $auth = user_auth_by_phone($phone_number);

    // if we have multi accounts
    if (isset($_POST['account'])) {
      // Get the JSON string from the POST data
      $account = $_POST['account'];
      if ($account) {
        // Loop through the array and check for 'CUSTNAME'
        foreach ($auth['value'] as $option) {
          if ( isset($option['CUSTNAME']) && $option['CUSTNAME'] == $account ) {
            $USER_values = $option;
            break;
          }
        }
      }
    } else {
      $USER_values = $auth['value'][0];

      $accounts = count($auth['value']);
      $is_crm_multiaccount = $accounts > 1;
    }

    // Check if user filled registration form in CRM
    $is_email_crm = $USER_values['EMAIL'] === null ? false : true;
    $is_policy_crm = $USER_values['MGEF_PRI_POLICY_FLAG'] === 'Y' ? true : false;
    $new_user_crm = $USER_values['CUSTNAME'] ? $USER_values['CUSTNAME'] : '';
    $update_wp_message = '';

    // Check if user exists in CRM, if not, create new user
    if (!$auth['success']) {
      if (!$user_id) {
        // Create new user in WordPress
        $new_user_id = create_user_wpdb($phone_number);
      }
    } else {
      // Handle existing users in WordPress
      if (is_array($users) && count($users) > 1) {
        // Multiple users found in WordPress
        $message = __('מישהו נרשם עם מספר הטלפון שלך, צור קשר עם מנהל המערכת ', 'geffen');
        wp_send_json(['success' => false, 'message' => $message]);
      }

      if ($user_id) {
        if (!$is_crm_multiaccount) {
          // Update user information in WordPress
          $update_wp_message = update_user_profile($user_id, $USER_values);
        }
      } else {
        // Create new user in WordPress
        $new_user_id = create_user_wpdb($phone_number);

        if ($new_user_id && !$is_crm_multiaccount) {
          // Update user information in WordPress if crm user registered
          $update_wp_message = update_user_profile($new_user_id, $USER_values);
        }
      }
    }

    // Send SMS
    $code = mt_rand(100000, 999999);
    $message = $code . ' ' . __('הוא קוד האימות החד פעמי שלך', 'geffen');
    $parameters = sms_params($message, $phone_number);
    $response = send_sms($parameters);

    // Handle response and save code to user profile
    if ($response !== false) {
      $user_id = $new_user_id ? $new_user_id : $user_id;
      update_user_meta($user_id, 'geffen_phone_code', $code);
    } else {
      wp_send_json(['success' => false, 'error' => __('שגיאה: שליחת SMS נכשלה.', 'geffen')]);
    }

    $is_user_crm = $is_email_crm && $is_policy_crm;

    // Send final JSON response
    wp_send_json(['success' => true, 'user' => $user_id, 'crmUser' => $new_user_crm, 'newUser' => !$is_user_crm, 'sms_response' => $response, 'crm_value' => $USER_values, 'update_wp_user' => $update_wp_message]);
  }
  wp_die();
}

add_action('wp_ajax_login_by_phone', 'login_by_phone');
add_action('wp_ajax_nopriv_login_by_phone', 'login_by_phone');

/**
 * Update user profile in WordPress
 */
function update_user_profile($user_id, $user_values) {
  $firstname = $user_values['FGEF_FIRSTNAME'];
  $lastname = $user_values['FGEF_LASTNAME'];
  $email = $user_values['EMAIL'];
  $subscription = $user_values['MGEF_MEMBERFLAG'] === 'Y' ? true : false;

  // Update the user first and last names in user meta
  update_user_meta($user_id, 'first_name', $firstname);
  update_user_meta($user_id, 'last_name', $lastname);

  // Update the user's billing details in user meta
  update_user_meta($user_id, 'billing_first_name', $firstname);
  update_user_meta($user_id, 'billing_last_name', $lastname);
  update_user_meta($user_id, 'billing_email', $email);

  // Update geffen_subscription based on $subscription value
  update_user_meta($user_id, 'geffen_subscription', $subscription);
  $user = new WP_User($user_id);
  if (!in_array('administrator', $user->roles)) {
    if ($subscription) {
      $user->set_role('club_member');
    } else {
      $user->set_role('customer');
    }
  }

  // Check if the email is already in use by another user
  if (email_exists($email) && email_exists($email) != $user_id) {
    // Handle the error appropriately in your application context
    return 'The email address is already in use: ' . $email;
  }

  // Update the user email and display name using wp_update_user
  $user_data = array(
    'ID'         => $user_id,
    'user_email' => $email,
    'display_name' => $firstname . ' ' . $lastname
  );
  $user_id = wp_update_user($user_data);

  // Check for errors
  if (is_wp_error($user_id)) {
    // There was an error; possibly this email is already taken
    $error_message = $user_id->get_error_message();
    // Handle the error appropriately in your application context
    return 'User update failed: ' . $error_message;
  }

  return 'User updated';
}
/**
 * Send SMS
 */
function send_sms($parameters) {
  $url = 'https://www.smscenter.co.il/Web/WebServices/SendMessage.asmx/SendMessagesV2';
  $body = http_build_query($parameters);
  $headers = ['Content-Type: application/x-www-form-urlencoded'];

  $ch = curl_init();
  curl_setopt($ch, CURLOPT_URL, $url);
  curl_setopt($ch, CURLOPT_POST, true);
  curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
  curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

  $response = curl_exec($ch);
  curl_close($ch);

  return $response;
}

/**
 * Login by email
 */
function login_by_email()
{
  $user_id = $_POST['userID'];
  $email = $_POST['email'];

  if (isset($user_id) && isset($email)) {
    $phone_code = get_user_meta($user_id, 'geffen_phone_code', true);

    $to = $email;
    $subject = 'קוד הגישה החד פעמי שלכם לאתר גפן ';
    $mail_message = __('Use this code to enter on site  - השתמש בקוד הגישה הזה לאימות באתר ', 'geffen') . "\r\n";
    $mail_message .= '<strong>' . $phone_code . '</strong>';

    // Send email with HTML content type
    $headers = get_header_for_email(); // return array with headers option

    $send = wp_mail($to, $subject, $mail_message, $headers);

    if ($send) {
      $message = __('קוד הגישה החד פעמי נשלח אלכתובת: ', 'geffen') . $email;
      wp_send_json(['success' => true, 'message' => $message]);
    }
  }

  wp_die();
}

add_action('wp_ajax_login_by_email', 'login_by_email');
add_action('wp_ajax_nopriv_login_by_email', 'login_by_email');

// Get Header for email
function get_header_for_email()
{
  return ['Content-Type: text/html; charset=UTF-8', 'From: GeffenMedical'];
}

/**
 * Login with generated Code
 */
function login_by_code()
{
  if (isset($_POST['code'])) {
    $user_id = sanitize_text_field($_POST['user']);
    $user_crm = sanitize_text_field($_POST['userCRM']);
    $code = sanitize_text_field($_POST['code']);
    $phone = sanitize_text_field($_POST['phone']);
    $phone_code = get_user_meta($user_id, 'geffen_phone_code', true);

    // block_user_brute_force($user_id);

    if ($user_id != '0') {
      $code = intval($code);
      $phone_code = intval($phone_code);

      if ($code == $phone_code) {
        wp_set_current_user($user_id);
        wp_set_auth_cookie($user_id);

        // Clear Code from user profile
        update_user_meta($user_id, 'geffen_phone_code', '');

        // get user info
        $user_info = get_userdata( $user_id );
        $first_name = $user_info->first_name;
        $last_name = $user_info->last_name;

        // Delete Brute force count
        delete_user_from_brute_force($user_id);

        $message = __('אינך רשום למערכת, הינך מועבר להרשמה', 'geffen');
        wp_send_json(['success' => true, 'message' => $message, 'notregister' => true, 'phone' => $phone, 'user' => $user_id, 'userName' => $first_name, 'userLastName' => $last_name, 'userCRM' => $user_crm]);
      } else {

        $message = __('הקוד שלך אינו חוקי ', 'geffen');
        wp_send_json(['success' => false, 'message' => $message]);

      }
    } else {

      $message = __('אינך רשום למערכת, הינך מועבר להרשמה', 'geffen');
      wp_send_json(['success' => false, 'message' => $message, 'notregister' => true, 'phone' => $phone]);

    }

  }

  wp_die();
}

add_action('wp_ajax_login_by_code', 'login_by_code');
add_action('wp_ajax_nopriv_login_by_code', 'login_by_code');

/**
 * Block user brute force
 */
function block_user_brute_force($user_id)
{
  // Check if the user has a key for counting requests
  $request_count_key = 'geffen_request_count_' . $user_id;
  $request_count = get_transient($request_count_key);

  $user_ip = $_SERVER['REMOTE_ADDR'];

  if (is_user_blocked($user_ip)) {
    $message = __('נחסמת זמנית, אנא נסה מאוחר יותר ', 'geffen');
    wp_send_json(['success' => false, 'blocked' => true, 'message' => $message]);
    wp_die();
  }

  if (!$request_count) {
    $request_count = 1;
    set_transient($request_count_key, $request_count, HOUR_IN_SECONDS);
  } else {
    $request_count++;
    set_transient($request_count_key, $request_count, HOUR_IN_SECONDS);
  }

  // If the request count exceeds 3, block the user
  if ($request_count > 3) {
    add_blocked_user($user_ip);

    $request_count = 0;
    set_transient($request_count_key, $request_count, HOUR_IN_SECONDS);

    // Block user
    $message = __('נחסמת בשל כמות ניסיונות מרובה, אנא נסה מאוחר יותר', 'geffen');
    wp_send_json(['success' => false, 'blocked' => true, 'message' => $message]);
    wp_die();
  }
}

function delete_user_from_brute_force($user_id)
{
  $request_count_key = 'geffen_request_count_' . $user_id;
  delete_transient($request_count_key);
}

function add_blocked_user($user_ip)
{
  $blocked_users = get_option('geffen_blocked_users', array());
  $blocked_users[$user_ip] = time() + HOUR_IN_SECONDS; // Store block expiration time (1 hour from now)
  update_option('geffen_blocked_users', $blocked_users);
}

function is_user_blocked($user_ip)
{
  $blocked_users = get_option('geffen_blocked_users', array());
  if (isset($blocked_users[$user_ip]) && $blocked_users[$user_ip] > time()) {
    return true; // User is blocked
  }
  return false; // User is not blocked or block expired
}

function remove_expired_blocked_users()
{
  $blocked_users = get_option('geffen_blocked_users', array());
  foreach ($blocked_users as $user_ip => $block_time) {
    if ($block_time <= time()) {
      unset($blocked_users[$user_ip]); // Remove expired block
    }
  }
  update_option('geffen_blocked_users', $blocked_users);
}

// Schedule cron event on plugin activation or theme activation
function schedule_blocked_user_cleanup()
{
  if (!wp_next_scheduled('geffen_remove_expired_blocked_users')) {
    wp_schedule_event(time(), 'hourly', 'geffen_remove_expired_blocked_users');
  }
}
add_action('init', 'schedule_blocked_user_cleanup');

// Hook to remove expired blocked users
add_action('geffen_remove_expired_blocked_users', 'remove_expired_blocked_users');
