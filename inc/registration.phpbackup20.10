<?php

/**
 * User Registration
 * @return void
 */
function geffen_update_user() {
  // Sanitize input data
  $username = sanitize_text_field($_POST['username']);
  $lastname = sanitize_text_field($_POST['lastname']);
  $user_crm = sanitize_text_field($_POST['userCRM']);
  $user_id = sanitize_text_field($_POST['newUser']);
  $phone = sanitize_text_field($_POST['phone']);
  $email = sanitize_email($_POST['email']);
  $offers = $_POST['offers'] == 'true' ? __('כן', 'geffen') : __('לא', 'geffen');
  $update_user_crm = null;

  $is_email_updated = '';

  // Update WordPress user data
  if ($user_id) {
    $user_data = array(
      'ID' => $user_id,
      'user_email' => $email,
    );

    $is_email_updated = wp_update_user($user_data);

    // Update user meta
    update_user_meta($user_id, 'first_name', $username);
    update_user_meta($user_id, 'last_name', $lastname);
    update_user_meta($user_id, 'email', $email);
    update_user_meta($user_id, 'billing_first_name', $username);
    update_user_meta($user_id, 'billing_last_name', $lastname);
    update_user_meta($user_id, 'billing_email', $email);

    // Set billing country to Israel
    update_user_meta($user_id, 'billing_country', 'IL');

    // Send notification email
    $user = get_user_by('ID', $user_id);
    $to = ['responstoclubemailes@geffenmedical1.onmicrosoft.com', 'shira.marton@geffenmedical.com'];
    $subject = 'משתמש חדש נרשם: ' . $user->user_login;
    $message = 'משתמש חדש נרשם באתר: ' . $username . ' ' . $lastname . ' - ' . $email . '(' .$user->user_login . ')' . "\r\n";
    $message .= 'המשתמש אישר קבלת ניוזלטרים: ' . $offers;
    $headers = get_header_for_email();

    // Get the user object
    $user = new WP_User($user_id);

    // update subscription
    if (!in_array('administrator', $user->roles)) {
      if ($_POST['offers'] == 'true') {
        wp_mail($to, $subject, $message, $headers);
        update_user_meta($user_id, 'geffen_subscription', true);
        $user->set_role('club_member');
      } else {
        update_user_meta($user_id, 'geffen_subscription', false);
        $user->set_role('customer');
      }
    }
  }

  // Update CRM data if user CRM ID is provided
  if (!$user_crm) {
    $is_offer = $_POST['offers'] == 'true' ? "Y" : "N";
    $is_privacy = $_POST['privacy'] == 'true' ? "Y" : "N";
    $username_replaced = str_replace("'", "~", $username);
    $lastname_replaced = str_replace("'", "~", $lastname);

    $crm_data = array(
      "FGEF_FIRSTNAME" => $username_replaced,
      "FGEF_LASTNAME" => $lastname_replaced,
      "PHONE" => $phone,
      "EMAIL" => $email,
      "MGEF_MEMBERFLAG" => $is_offer,
      "MGEF_PRI_POLICY_FLAG" => $is_privacy,
    );

    $update_user_crm = create_user_in_crm($crm_data);

    if ($update_user_crm) {
      update_user_meta($user_id, 'user_crm_id', $update_user_crm);
    }
  }

  wp_send_json(['userID' => $user_id, 'user_updated' => $is_email_updated, 'userCRM' => $user_crm, 'crm_updated' => $update_user_crm]);
}
add_action('wp_ajax_geffen_update_user', 'geffen_update_user');
add_action('wp_ajax_nopriv_geffen_update_user', 'geffen_update_user');

// Save Subscription Data to User Profile
function save_subscription() {

  $form_data = $_POST['formData'];
  $data = [];

  foreach ($form_data as $item) {
    $data[$item['name']] = $item['value'];
  }

  // Verify nonce
  if ( ! isset( $data['subscription_nonce'] ) || ! wp_verify_nonce( $data['subscription_nonce'], 'save_subscription' ) ) {
    // Nonce is invalid, handle the error here
    wp_send_json_error( ['message' => 'Invalid nonce'] );
  }

  // Get user ID
  $user_id = isset( $data['user-id'] ) ? intval( $data['user-id'] ) : 0;

  // Check if user ID is valid
  if ( ! $user_id ) {
    // Invalid user ID, handle the error here
    wp_send_json_error( ['message' => 'Invalid user ID'] );
  }

  // Check if "offers" checkbox is checked
  $offers_checked = isset( $data['offers'] ) && $data['offers'] === 'on';

  // Get the user object
  $user = new WP_User($user_id);

  // Update user meta if "offers" checkbox is checked
  if (!in_array('administrator', $user->roles)) {
    if ( $offers_checked ) {
      update_user_meta( $user_id, 'geffen_subscription', true );
      $user->set_role('club_member');

      // Send success response
      wp_send_json_success( ['message' => 'Subscription checked', 'url' => $data['checkout_url']] );
    } else {
      // If not checked, remove the meta key
      update_user_meta( $user_id, 'geffen_subscription', false );
      $user->set_role('customer');

      // Send error response
      wp_send_json_error( ['message' => 'Subscription unchecked', 'url' => $data['checkout_url']] );
    }
  }

  // Make sure to exit after sending the response
  wp_die();
}

add_action('wp_ajax_save_subscription', 'save_subscription');
add_action('wp_ajax_nopriv_save_subscription', 'save_subscription'); // If you want it to work for non-logged-in users as well


// Display phone number field in user profile
function add_phone_field_to_profile($user)
{
  ?>
  <h3><?php _e('Personal Information', 'geffen'); ?></h3>
  <table class="form-table">
    <tr>
      <th><label for="user_crm_id"><?php _e('User CRM ID', 'geffen'); ?></label></th>
      <td>
        <input type="text" name="user_crm_id" id="user_crm_id" value="<?php echo esc_attr(get_user_meta($user->ID, 'user_crm_id', true)); ?>" class="regular-text" />
        <p class="description"><?php _e('Enter the User CRM ID.', 'geffen'); ?></p>
      </td>
    </tr>

    <tr>
      <th><label for="geffen_phone"><?php _e('Phone Number', 'geffen'); ?></label></th>
      <td>
        <input type="text" name="geffen_phone" id="geffen_phone"
          value="<?php echo esc_attr(get_the_author_meta('geffen_phone', $user->ID)); ?>" class="regular-text"
          placeholder="123456789" /><br />
        <span class="description"><?php _e('Please enter your phone number.', 'geffen'); ?></span>

        <input type="hidden" name="geffen_phone_code" id="geffen_phone_code"
          value="<?php echo esc_attr(get_the_author_meta('geffen_phone_code', $user->ID)); ?>" /><br />
      </td>
    </tr>

    <tr>
      <th><label for="geffen_subscription"><?php _e('Subscribe to Newsletter', 'your_textdomain'); ?></label></th>
      <td>
        <input type="checkbox" name="geffen_subscription" id="geffen_subscription" value="1"
          <?php checked(1, get_user_meta($user->ID, 'geffen_subscription', true), true); ?> />
        <span class="description"><?php _e('Check to subscribe to the newsletter.', 'your_textdomain'); ?></span>
      </td>
    </tr>
  </table>
  <?php
}
add_action('show_user_profile', 'add_phone_field_to_profile');
add_action('edit_user_profile', 'add_phone_field_to_profile');


// Save phone number field data
function save_phone_field_data($user_id) {
  if (!current_user_can('edit_user', $user_id)) {
    return false;
  }

  update_user_meta($user_id, 'geffen_phone', sanitize_text_field($_POST['geffen_phone']));
  update_user_meta($user_id, 'geffen_subscription', $_POST['geffen_subscription']);
  update_user_meta($user_id, 'user_crm_id', sanitize_text_field($_POST['user_crm_id']));
}
add_action('personal_options_update', 'save_phone_field_data');
add_action('edit_user_profile_update', 'save_phone_field_data');

// Find User ID by phone number
function get_user_id_by_phone_number($phone_number)
{
  global $wpdb;

  // Search for the user ID based on the phone number in user meta
  $user_ids = $wpdb->get_col(
    $wpdb->prepare(
      "SELECT user_id FROM $wpdb->usermeta WHERE meta_key = 'geffen_phone' AND meta_value = %s",
      $phone_number
    )
  );

  // If user IDs are found, return the first one (assuming unique phone numbers)
  if (!empty($user_ids)) {
    return $user_ids;
  }

  return false;
}


// Add custom column for 'Phone Number' in the user table
function add_custom_user_column($columns)
{
  $columns['geffen_phone'] = 'Phone Number';
  return $columns;
}
add_filter('manage_users_columns', 'add_custom_user_column');


// Display 'geffen_phone' data in the custom column
function display_custom_user_column($value, $column_name, $user_id)
{
  if ($column_name === 'geffen_phone') {
    $phone_number = get_user_meta($user_id, 'geffen_phone', true);
    return $phone_number ? esc_html($phone_number) : 'N/A';
  }
  return $value;
}
add_filter('manage_users_custom_column', 'display_custom_user_column', 10, 3);

// Add custom columns for 'Phone Number' and 'Subscription' in the user table
function add_custom_user_columns($columns)
{
  $columns['geffen_phone'] = 'Phone Number';
  $columns['geffen_subscription'] = 'Subscription';
  return $columns;
}
add_filter('manage_users_columns', 'add_custom_user_columns');

// Display 'geffen_phone' and 'geffen_subscription' data in the custom columns
function display_custom_user_columns($value, $column_name, $user_id)
{
  if ($column_name === 'geffen_phone') {
    $phone_number = get_user_meta($user_id, 'geffen_phone', true);
    return $phone_number ? esc_html($phone_number) : 'N/A';
  }
  if ($column_name === 'geffen_subscription') {
    $subscription = get_user_meta($user_id, 'geffen_subscription', true);
    return $subscription ? 'YES' : 'NO';
  }
  return $value;
}
add_filter('manage_users_custom_column', 'display_custom_user_columns', 10, 3);

// Make custom columns sortable
function sortable_custom_user_columns($columns)
{
  $columns['geffen_phone'] = 'geffen_phone';
  $columns['geffen_subscription'] = 'geffen_subscription';
  return $columns;
}
add_filter('manage_users_sortable_columns', 'sortable_custom_user_columns');

// Handle sorting by custom columns
function custom_column_orderby($query)
{
  if (!is_admin()) {
    return;
  }

  $orderby = $query->get('orderby');
  if ($orderby == 'geffen_phone') {
    $query->set('meta_key', 'geffen_phone');
    $query->set('orderby', 'meta_value');
  }
  if ($orderby == 'geffen_subscription') {
    $query->set('meta_key', 'geffen_subscription');
    $query->set('orderby', 'meta_value');
  }
}
add_action('pre_get_users', 'custom_column_orderby');

// Save Subscription
function geffen_join_club()
{
  $user_id = get_current_user_id();

  // Get the user object
  $user = new WP_User($user_id);

  if (!in_array('administrator', $user->roles)) {
    if (isset($_POST['subscribed']) && $_POST['subscribed'] === 'on') {
      $response = update_user_meta( $user_id, 'geffen_subscription', true );
      $user->set_role('club_member');

      wp_send_json_success($response);
    } else {
      // If not checked, remove the meta key
      $response = update_user_meta( $user_id, 'geffen_subscription', false );
      $user->set_role('customer');

      // Send error response
      wp_send_json_error($response);
    }
  }
  wp_send_json_error('Something went wrong or use admin');
}
add_action('wp_ajax_geffen_join_club', 'geffen_join_club');
add_action('wp_ajax_nopriv_geffen_join_club', 'geffen_join_club');